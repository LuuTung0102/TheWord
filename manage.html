<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω m·∫´u - TheWord</title>
  <link rel="stylesheet" href="style.css">
  <!-- Offline fonts and icons removed for offline deployment -->
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="header-content">
        <button class="back-btn" onclick="location.href='index.html'">
          <span class="icon">‚Üê</span>
          <span>Trang ch√≠nh</span>
        </button>
        <div class="header-title">
          <span class="icon">‚öôÔ∏è</span>
          <h1>Qu·∫£n l√Ω m·∫´u</h1>
        </div>
        <div class="header-actions">
          <button class="help-btn" onclick="showHelp()" title="Tr·ª£ gi√∫p">
            <span class="icon">‚ùì</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Upload Section -->
      <section class="upload-section">
        <div class="section-header">
          <h2><span class="icon">üì§</span> Th√™m m·∫´u m·ªõi</h2>
          <p>Upload file Word (.docx) ƒë·ªÉ th√™m v√†o th∆∞ vi·ªán m·∫´u</p>
        </div>
        
        <div class="upload-card">
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
              <span class="icon">‚òÅÔ∏è</span>
            </div>
            <h3>K√©o th·∫£ file Word v√†o ƒë√¢y</h3>
            <p>Ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn file</p>
            <input type="file" id="fileInput" accept=".docx" multiple style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
              <span class="icon">üìÅ</span>
              Ch·ªçn file
            </button>
          </div>
          
          <div class="upload-progress" id="uploadProgress" style="display: none;">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">ƒêang upload...</div>
          </div>
        </div>
      </section>

      <!-- Templates List -->
      <section class="templates-section">
        <div class="section-header">
          <h2><span class="icon">üìÑ</span> M·∫´u c√≥ s·∫µn</h2>
          <p>Qu·∫£n l√Ω c√°c m·∫´u Word trong th∆∞ vi·ªán</p>
        </div>
        
        <div class="templates-controls">
          <div class="search-container">
            <span class="icon">üîç</span>
            <input type="text" id="searchTemplates" placeholder="T√¨m ki·∫øm m·∫´u...">
          </div>
          <div class="view-controls">
            <button class="view-btn active" data-view="grid" title="Xem d·∫°ng l∆∞·ªõi">
              <span class="icon">‚äû</span>
            </button>
            <button class="view-btn" data-view="list" title="Xem d·∫°ng danh s√°ch">
              <span class="icon">‚ò∞</span>
            </button>
          </div>
        </div>
        
        <div class="templates-grid" id="templatesGrid">
          <!-- Templates will be loaded here -->
        </div>
        
        <div class="empty-state" id="emptyState" style="display: none;">
          <span class="icon">üìÅ</span>
          <h3>Ch∆∞a c√≥ m·∫´u n√†o</h3>
          <p>H√£y upload file Word ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
        </div>
      </section>
    </main>
  </div>

  <!-- Template Preview Modal -->
  <div class="modal-overlay" id="previewModal" style="display: none;">
    <div class="modal-content preview">
      <div class="modal-header">
        <h3 id="previewTitle">Xem tr∆∞·ªõc m·∫´u</h3>
        <button class="close-btn" onclick="closePreviewModal()">
          <span class="icon">‚úï</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="preview-info">
          <div class="preview-item">
            <label>T√™n file:</label>
            <span id="previewFileName"></span>
          </div>
          <div class="preview-item">
            <label>K√≠ch th∆∞·ªõc:</label>
            <span id="previewFileSize"></span>
          </div>
          <div class="preview-item">
            <label>Ng√†y t·∫°o:</label>
            <span id="previewFileDate"></span>
          </div>
          <div class="preview-item">
            <label>Placeholders:</label>
            <span id="previewPlaceholders"></span>
          </div>
        </div>
        <div class="preview-actions">
          <button class="btn-secondary" onclick="closePreviewModal()">ƒê√≥ng</button>
          <button class="btn-primary" onclick="useTemplate()">S·ª≠ d·ª•ng m·∫´u</button>
        </div>
      </div>
    </div>
    </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal" style="display: none;">
    <div class="modal-content error">
      <div class="modal-icon">
        <span class="icon">‚ö†Ô∏è</span>
      </div>
      <h3>X√°c nh·∫≠n x√≥a</h3>
      <p id="deleteMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·∫´u n√†y kh√¥ng?</p>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeDeleteModal()">H·ªßy</button>
        <button class="btn-danger" onclick="confirmDelete()">X√≥a</button>
      </div>
    </div>
  </div>

  <script src="renderer/electron-imports.js"></script>
  <script src="renderer/utils.js"></script>

  <script>
    let templates = [];
    let currentView = 'grid';
    let deleteTemplateName = '';

    // Load templates
    async function loadTemplates() {
      try {
        console.log('üîç Loading templates...');
        templates = await window.ipcRenderer.invoke('get-templates');
        console.log('üîç Templates loaded:', templates);
        renderTemplates();
        updateEmptyState();
      } catch (error) {
        console.error('Error loading templates:', error);
        showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch m·∫´u');
      }
    }

    // Render templates
    function renderTemplates() {
      const grid = document.getElementById('templatesGrid');
      const searchTerm = document.getElementById('searchTemplates').value.toLowerCase();
      
      const filteredTemplates = templates.filter(template => 
        template.toLowerCase().includes(searchTerm)
      );

      if (currentView === 'grid') {
        grid.className = 'templates-grid';
        grid.innerHTML = filteredTemplates.map(template => `
          <div class="template-card" data-template="${template}">
            <div class="template-icon">
              <i class="fas fa-file-word"></i>
            </div>
            <div class="template-info">
              <h4 class="template-name">${template}</h4>
              <p class="template-meta">File Word</p>
            </div>
            <div class="template-actions">
              <button class="action-btn preview" onclick="previewTemplate('${template}')" title="Xem tr∆∞·ªõc">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn delete" onclick="deleteTemplate('${template}')" title="X√≥a">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
      } else {
        grid.className = 'templates-list';
        grid.innerHTML = filteredTemplates.map(template => `
          <div class="template-item" data-template="${template}">
            <div class="template-icon">
              <i class="fas fa-file-word"></i>
            </div>
            <div class="template-info">
              <h4 class="template-name">${template}</h4>
              <p class="template-meta">File Word</p>
            </div>
            <div class="template-actions">
              <button class="action-btn preview" onclick="previewTemplate('${template}')" title="Xem tr∆∞·ªõc">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn delete" onclick="deleteTemplate('${template}')" title="X√≥a">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
      }
    }

    // Update empty state
    function updateEmptyState() {
      const emptyState = document.getElementById('emptyState');
      const grid = document.getElementById('templatesGrid');
      
      if (templates.length === 0) {
        emptyState.style.display = 'block';
        grid.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        grid.style.display = 'grid';
      }
    }

    // Upload file
    function setupFileUpload() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      const uploadProgress = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      // Drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        handleFiles(files);
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });

      async function handleFiles(files) {
        const docxFiles = Array.from(files).filter(file => 
          file.name.toLowerCase().endsWith('.docx')
        );

        if (docxFiles.length === 0) {
          showError('Vui l√≤ng ch·ªçn file Word (.docx)');
          return;
        }

        uploadProgress.style.display = 'block';
        
        for (let i = 0; i < docxFiles.length; i++) {
          const file = docxFiles[i];
          const progress = ((i + 1) / docxFiles.length) * 100;
          
          progressFill.style.width = `${progress}%`;
          progressText.textContent = `ƒêang upload ${file.name}...`;
          
          try {
            // Read file as buffer
            const buffer = await file.arrayBuffer();
            const fileName = file.name;
            
            // Save file to temp location first
            const tempPath = await window.ipcRenderer.invoke('save-temp-file', {
              buffer: Array.from(new Uint8Array(buffer)),
              fileName: fileName
            });
            
            // Then upload to templates directory
            await window.ipcRenderer.invoke('upload-template', tempPath);
          } catch (error) {
            console.error('Upload error:', error);
            showError(`L·ªói khi upload ${file.name}`);
          }
        }
        
        progressText.textContent = 'Upload ho√†n t·∫•t!';
        setTimeout(() => {
          uploadProgress.style.display = 'none';
          loadTemplates();
        }, 1000);
      }
    }

    // Preview template
    async function previewTemplate(templateName) {
      try {
        const placeholders = await window.ipcRenderer.invoke('get-placeholders', templateName);
        
        document.getElementById('previewTitle').textContent = `Xem tr∆∞·ªõc: ${templateName}`;
        document.getElementById('previewFileName').textContent = templateName;
        document.getElementById('previewFileSize').textContent = 'N/A';
        document.getElementById('previewFileDate').textContent = new Date().toLocaleDateString();
        document.getElementById('previewPlaceholders').textContent = placeholders.length;
        
        document.getElementById('previewModal').style.display = 'flex';
      } catch (error) {
        console.error('Preview error:', error);
        showError('Kh√¥ng th·ªÉ xem tr∆∞·ªõc m·∫´u');
      }
    }

    // Close preview modal
    function closePreviewModal() {
      document.getElementById('previewModal').style.display = 'none';
    }

    // Use template
    function useTemplate() {
      closePreviewModal();
      location.href = 'export.html';
    }

    // Delete template
    function deleteTemplate(templateName) {
      deleteTemplateName = templateName;
      document.getElementById('deleteMessage').textContent = 
        `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·∫´u "${templateName}" kh√¥ng?`;
      document.getElementById('deleteModal').style.display = 'flex';
    }

    // Close delete modal
    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      deleteTemplateName = '';
    }

    // Confirm delete
    async function confirmDelete() {
      try {
        await window.ipcRenderer.invoke('delete-template', deleteTemplateName);
        closeDeleteModal();
        loadTemplates();
        showSuccess(`ƒê√£ x√≥a m·∫´u "${deleteTemplateName}"`);
      } catch (error) {
        console.error('Delete error:', error);
        showError('Kh√¥ng th·ªÉ x√≥a m·∫´u');
      }
    }

    // Setup view controls
    function setupViewControls() {
      const viewBtns = document.querySelectorAll('.view-btn');
      viewBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          viewBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = btn.dataset.view;
          renderTemplates();
        });
      });
    }

    // Setup search
    function setupSearch() {
      const searchInput = document.getElementById('searchTemplates');
      searchInput.addEventListener('input', renderTemplates);
    }

    // Show help
    function showHelp() {
      alert('H∆∞·ªõng d·∫´n qu·∫£n l√Ω m·∫´u:\n\n1. Upload file Word (.docx) ƒë·ªÉ th√™m m·∫´u\n2. Xem tr∆∞·ªõc m·∫´u ƒë·ªÉ ki·ªÉm tra placeholders\n3. X√≥a m·∫´u kh√¥ng c·∫ßn thi·∫øt\n4. S·ª≠ d·ª•ng m·∫´u ƒë·ªÉ t·∫°o t√†i li·ªáu');
    }

    // Show success message
    function showSuccess(message) {
      // Simple alert for now, can be replaced with toast notification
      alert('‚úÖ ' + message);
    }

    // Show error message
    function showError(message) {
      // Simple alert for now, can be replaced with toast notification
      alert('‚ùå ' + message);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadTemplates();
      setupFileUpload();
      setupViewControls();
      setupSearch();
    });
  </script>

  <style>
    /* Additional styles for manage page */
    .upload-section {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      margin-bottom: var(--space-8);
    }

    .upload-card {
      margin-top: var(--space-6);
    }

    .upload-area {
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-lg);
      padding: var(--space-12);
      text-align: center;
      transition: all var(--transition-fast);
      cursor: pointer;
    }

    .upload-area:hover,
    .upload-area.drag-over {
      border-color: var(--primary-color);
      background: var(--primary-light);
    }

    .upload-icon {
      font-size: var(--font-size-4xl);
      color: var(--primary-color);
      margin-bottom: var(--space-6);
    }

    .upload-area h3 {
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: var(--space-3);
    }

    .upload-area p {
      color: var(--gray-600);
      margin-bottom: var(--space-6);
    }

    .upload-btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-6);
      background: var(--primary-color);
      border: none;
      border-radius: var(--radius-md);
      color: var(--white);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .upload-btn:hover {
      background: var(--primary-hover);
    }

    .upload-progress {
      margin-top: var(--space-6);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--gray-200);
      border-radius: var(--radius-sm);
      overflow: hidden;
      margin-bottom: var(--space-3);
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      transition: width var(--transition-normal);
      width: 0%;
    }

    .progress-text {
      text-align: center;
      color: var(--gray-600);
      font-size: var(--font-size-sm);
    }

    .templates-section {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
    }

    .templates-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
      gap: var(--space-4);
    }

    .templates-controls .search-container {
      flex: 1;
      max-width: 400px;
    }

    .view-controls {
      display: flex;
      gap: var(--space-2);
    }

    .view-btn {
      width: 40px;
      height: 40px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      background: var(--white);
      color: var(--gray-600);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .view-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .view-btn.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: var(--white);
    }

    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--space-6);
    }

    .templates-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .template-card {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      transition: all var(--transition-fast);
    }

    .template-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .template-item {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      transition: all var(--transition-fast);
    }

    .template-item:hover {
      box-shadow: var(--shadow-md);
    }

    .template-icon {
      width: 48px;
      height: 48px;
      background: var(--primary-light);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-color);
      font-size: var(--font-size-lg);
    }

    .template-info {
      flex: 1;
    }

    .template-name {
      font-size: var(--font-size-base);
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: var(--space-1);
    }

    .template-meta {
      color: var(--gray-600);
      font-size: var(--font-size-sm);
    }

    .template-actions {
      display: flex;
      gap: var(--space-2);
    }

    .action-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      background: var(--white);
      color: var(--gray-600);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .action-btn.preview:hover {
      background: var(--primary-light);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .action-btn.delete:hover {
      background: var(--error-color);
      border-color: var(--error-color);
      color: var(--white);
    }

    .modal-content.preview {
      max-width: 600px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--gray-200);
    }

    .modal-header h3 {
      margin: 0;
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--gray-900);
    }

    .close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      border-radius: var(--radius-md);
      color: var(--gray-600);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: var(--gray-200);
      color: var(--gray-800);
    }

    .preview-info {
      margin-bottom: var(--space-6);
    }

    .preview-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-3) 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .preview-item:last-child {
      border-bottom: none;
    }

    .preview-item label {
      font-weight: 600;
      color: var(--gray-700);
    }

    .preview-item span {
      color: var(--gray-600);
    }

    .btn-danger {
      padding: var(--space-3) var(--space-6);
      background: var(--error-color);
      border: none;
      border-radius: var(--radius-md);
      color: var(--white);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-danger:hover {
      background: var(--error-hover);
    }

    @media (max-width: 768px) {
      .templates-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .templates-grid {
        grid-template-columns: 1fr;
      }

      .template-item {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>
</body>
</html>